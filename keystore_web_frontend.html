<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Management v0.6</title>
    <link rel="stylesheet" href="style.css"> <!-- Link to external CSS file -->
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="header">
                <h1>üîê API Key Management Service</h1>
            </div>
            <div class="main-content">
                <div class="login-form">
                    <h2 style="margin-bottom: 30px; color: #333;">Sign In</h2>
                    <div id="loginAlert"></div>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        <button type="submit" class="btn" id="loginBtn">
                            Sign In
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <h1>üîê API Key Management Service </h1>
                <div class="user-info">
                    <span id="currentUser"></span>
                    <span id="userRole" class="user-badge"></span>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>
            
            <div class="main-content">
                <div id="appAlert"></div>
                
                <div class="tabs">
                    <button class="tab active" onclick="showTab('keys')">API Keys</button>
                    <button class="tab" onclick="showTab('logs')">Access Logs</button>
                    <button class="tab" id="usersTabButton" onclick="showTab('users')" style="display: none;">Users</button> <!-- Changed ID here -->
                </div>

                <!-- API Keys Tab -->
                <div id="keysTab" class="tab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>API Keys</h2>
                        <button class="btn" id="addKeyButton">+ Add New Key</button> <!-- Added ID for delegation -->
                    </div>
                    <div id="keysContainer">
                        <table class="keys-table">
                            <thead>
                                <tr>
                                    <th>Date Created</th>
                                    <th>User</th>
                                    <th>Key Name</th>
                                    <th>API Key</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="keysTableBody">
                                <!-- Keys will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Access Logs Tab -->
                <div id="logsTab" class="tab-content">
                    <h2>Access Logs</h2>
                    <div id="logsContainer">
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                            <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                                <label for="logUserFilter">Filter by User</label>
                                <input type="text" id="logUserFilter" placeholder="Enter username">
                            </div>
                            <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                                <label for="logActionFilter">Filter by Action</label>
                                <input type="text" id="logActionFilter" placeholder="Enter action type">
                            </div>
                            <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                                <label for="logIpFilter">Filter by IP Address</label>
                                <input type="text" id="logIpFilter" placeholder="Enter IP address">
                            </div>
                            <button class="btn" onclick="loadLogs()">Apply Filters</button>
                            <button class="btn btn-secondary" onclick="clearLogFilters()">Clear Filters</button>
                        </div>
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Key Name</th>
                                    <th>Action</th>
                                    <th>IP Address</th>
                                    <th>Success</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <!-- Logs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Tab (Admin Only) -->
                <div id="usersTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Users</h2>
                        <button class="btn" id="addUserButton">+ Add New User</button> <!-- Added ID for delegation -->
                    </div>
                    <div id="usersContainer">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Created At</th>
                                    <th>Last Login</th>
                                    <th>Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Key Modal -->
    <div id="keyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="keyModalTitle">Add API Key</h2>
                <span class="close" onclick="closeModal('keyModal')">&times;</span>
            </div>
            <form id="keyForm">
                <div class="form-group">
                    <label for="keyName">Key Name</label>
                    <input type="text" id="keyName" name="keyName" required>
                </div>
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="text" id="apiKey" name="apiKey" required>
                    <small style="color: #666;">
                        <input type="checkbox" id="toggleApiKeyVisibilityCheckbox" onchange="toggleApiKeyVisibility()">
                        <span id="apiKeyVisibilityLabel">Show Full Key</span>
                    </small>
                </div>
                <div class="form-group">
                    <label for="keyDescription">Description (Optional)</label>
                    <textarea id="keyDescription" name="keyDescription" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('keyModal')">Cancel</button>
                    <button type="submit" class="btn" id="keySubmitBtn">Save Key</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
                <span class="close" onclick="closeModal('userModal')">&times;</span>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" name="newUsername" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">Password</label>
                    <input type="password" id="newPassword" name="newPassword" required>
                </div>
                <div class="form-group">
                    <label for="newUserRole">Role</label>
                    <select id="newUserRole" name="newUserRole">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group hidden" id="userIsActiveGroup">
                    <input type="checkbox" id="newUserIsActive" name="newUserIsActive">
                    <label for="newUserIsActive" style="display: inline-block; margin-left: 5px;">User is Active</label>
                </div>

                <div style="display: flex; gap: 10px; justify-content: end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                    <button type="submit" class="btn" id="userSubmitBtn">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let userRole = null;
        let authToken = null;
        let editingKey = null; // Used for key edit mode (stores keyName)
        let editingUser = null; // Used for user edit mode (stores userId)
        let tempFullApiKey = ''; // Stores the full API key for masking/unmasking in edit mode

        // API Base URL
        const API_BASE = 'http://localhost:5000';

        // HTML element references (cached for performance and cleaner code)
        const apiKeyInput = document.getElementById('apiKey');
        const toggleCheckbox = document.getElementById('toggleApiKeyVisibilityCheckbox');
        const apiKeyVisibilityLabel = document.getElementById('apiKeyVisibilityLabel');
        const keysTableBody = document.getElementById('keysTableBody');
        const usersTableBody = document.getElementById('usersTableBody');
        const addKeyButton = document.getElementById('addKeyButton'); // New ID
        const addUserButton = document.getElementById('addUserButton'); // New ID


        // Helper function to get the masked API key string
        function getMaskedApiKeyDisplay(fullApiKey) {
            if (!fullApiKey) return '';
            const displayLength = 40; // Fixed display length for the API Key column
            const visibleChars = 5;

            const keyString = String(fullApiKey); // Ensure it's a string

            if (keyString.length <= visibleChars) {
                return keyString.padEnd(displayLength, ' ');
            } else {
                const maskedPartLength = Math.max(0, displayLength - visibleChars);
                const maskedPart = '*'.repeat(maskedPartLength);
                const visiblePart = keyString.slice(-visibleChars);
                return maskedPart + visiblePart;
            }
        }

        // Handles toggling between masked/full API key view for the edit modal
        function toggleApiKeyVisibility() {
            const isChecked = toggleCheckbox.checked;

            if (isChecked) {
                apiKeyInput.value = tempFullApiKey;
                apiKeyVisibilityLabel.textContent = 'Hide Full Key';
            } else {
                apiKeyInput.value = getMaskedApiKeyDisplay(tempFullApiKey);
                apiKeyVisibilityLabel.textContent = 'Show Full Key';
            }
            apiKeyInput.type = 'text'; // Always display as text when masked/unmasked
        }

        // CORE FUNCTIONS - Defined in global scope for event delegation to find them
        async function viewKey(keyName) {
            try {
                const response = await fetch(`${API_BASE}/keys/${keyName}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const fullApiKey = data.api_key;
                    const displayApiKey = getMaskedApiKeyDisplay(fullApiKey);
                    
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'flex';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>API Key: ${keyName}</h2>
                                <span class="close" onclick="closeModal(this.closest('.modal').id)">&times;</span>
                            </div>
                            <div class="form-group">
                                <label>Key Value:</label>
                                <input type="text" value="${displayApiKey}" readonly style="font-family: monospace;">
                                <button class="btn" onclick="copyToClipboard('${fullApiKey}'); showAlert('appAlert', 'Key copied to clipboard!', 'success')" style="margin-top: 10px;">Copy to Clipboard</button>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal(this.closest('.modal').id)">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to retrieve key');
                }
            } catch (error) {
                showAlert('appAlert', `Failed to retrieve API key: ${error.message}`, 'error');
                if (error.message.includes('token')) { logout(); }
            }
        }

        async function editKey(keyName) {
            editingKey = keyName;
            document.getElementById('keyModalTitle').textContent = 'Edit API Key';
            document.getElementById('keyName').value = keyName;
            document.getElementById('keyName').disabled = true;
            document.getElementById('keySubmitBtn').textContent = 'Update Key';
            document.getElementById('keyForm').reset();
            document.getElementById('keyName').value = keyName; // Re-set keyName as reset clears it

            try {
                const response = await fetch(`${API_BASE}/keys/${keyName}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('keyDescription').value = data.description || '';
                    tempFullApiKey = data.api_key;

                    apiKeyInput.value = getMaskedApiKeyDisplay(tempFullApiKey);
                    apiKeyInput.type = 'text';
                    toggleCheckbox.checked = true;
                    apiKeyVisibilityLabel.textContent = 'Hide Full Key';

                    apiKeyInput.required = false;
                }
            } catch (error) {
                console.error("Failed to pre-fill key for editing:", error);
                showAlert('appAlert', `Could not load existing key details for editing: ${error.message}`, 'error');
            }
            document.getElementById('keyModal').style.display = 'flex';
        }

        async function deleteKey(keyName) {
            if (!confirm(`Are you sure you want to delete the API key "${keyName}"?`)) { return; }
            
            try {
                const response = await fetch(`${API_BASE}/keys/${keyName}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showAlert('appAlert', 'API key deleted successfully', 'success');
                    loadKeys();
                    loadLogs();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete key');
                }
            } catch (error) {
                showAlert('appAlert', `Failed to delete API key: ${error.message}`, 'error');
                if (error.message.includes('token')) { logout(); }
            }
        }

        async function editUser(userId, username, role, isActive) {
            editingUser = userId;
            document.getElementById('userForm').reset();
            document.getElementById('userModalTitle').textContent = `Edit User: ${username}`;
            document.getElementById('newUsername').value = username;
            document.getElementById('newUsername').disabled = true;
            document.getElementById('newPassword').required = false;
            document.getElementById('newUserRole').value = role;
            document.getElementById('newUserIsActive').checked = isActive;
            document.getElementById('userIsActiveGroup').classList.remove('hidden');
            document.getElementById('userSubmitBtn').textContent = 'Update User';
            document.getElementById('userModal').style.display = 'flex';
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user "${username}" (ID: ${userId})? This will also delete ALL their API keys!`)) { return; }
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showAlert('appAlert', `User "${username}" deleted successfully.`, 'success');
                    loadUsers();
                    loadLogs();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Failed to delete user "${username}"`);
                }
            } catch (error) {
                showAlert('appAlert', `Delete user failed: ${error.message}`, 'error');
                if (error.message.includes('token')) { logout(); }
            }
        }


        // INITIALIZATION AND EVENT LISTENERS SETUP
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('keyForm').addEventListener('submit', handleKeySubmit);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);

            // Add event listeners for log filters to trigger loadLogs on input change
            document.getElementById('logUserFilter').addEventListener('input', loadLogsDebounced);
            document.getElementById('logActionFilter').addEventListener('input', loadLogsDebounced);
            document.getElementById('logIpFilter').addEventListener('input', loadLogsDebounced);

            // Event delegation for "Add New Key" button
            addKeyButton.addEventListener('click', showAddKeyModal);
            // Event delegation for "Add New User" button
            addUserButton.addEventListener('click', showAddUserModal);


            // Event delegation for Edit/Delete/View buttons on the keys table
            keysTableBody.addEventListener('click', function(event) {
                const target = event.target;
                const keyName = target.dataset.keyname; // Get keyname from dataset

                if (target.classList.contains('btn')) { // Check if a button was clicked
                    if (target.textContent.trim() === 'Edit') {
                        if (keyName) { editKey(keyName); }
                    } else if (target.textContent.trim() === 'Delete') {
                        if (keyName) { deleteKey(keyName); }
                    } else if (target.textContent.trim() === 'View') {
                        if (keyName) { viewKey(keyName); }
                    }
                }
            });
            
            // Event delegation for Edit/Delete buttons on the users table
            if (usersTableBody) {
                usersTableBody.addEventListener('click', function(event) {
                    const target = event.target;
                    const userId = target.dataset.userid; // Get userid from dataset

                    if (target.classList.contains('btn')) { // Check if a button was clicked
                        if (target.textContent.trim() === 'Edit') {
                            const username = target.dataset.username;
                            const role = target.dataset.userrole;
                            const isActive = target.dataset.isactive === 'true';
                            if (userId) { editUser(parseInt(userId), username, role, isActive); }
                        } else if (target.textContent.trim() === 'Delete') {
                            const username = target.dataset.username;
                            if (userId) { deleteUser(parseInt(userId), username); }
                        }
                    }
                });
            }
        }

        // Debounce function to limit how often loadLogs is called on input
        let logFilterTimeout;
        function loadLogsDebounced() {
            clearTimeout(logFilterTimeout);
            logFilterTimeout = setTimeout(loadLogs, 500); // Wait 500ms after last input
        }


        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            const role = localStorage.getItem('userRole');
            
            if (token && user && role) {
                authToken = token;
                currentUser = user;
                userRole = role;
                showMainApp();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.innerHTML;
            
            try {
                loginBtn.innerHTML = '<span class="loading"></span> Signing in...';
                loginBtn.disabled = true;

                const formData = new FormData(e.target);
                const username = formData.get('username');
                const password = formData.get('password');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    currentUser = data.user;
                    userRole = data.role;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', currentUser);
                    localStorage.setItem('userRole', userRole);
                    
                    showMainApp();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Invalid credentials');
                }
            } catch (error) {
                showAlert('loginAlert', error.message, 'error');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('userRole').textContent = userRole;
            
            if (userRole === 'admin') {
                document.getElementById('usersTabButton').style.display = 'block';
            } else {
                document.getElementById('usersTabButton').style.display = 'none';
            }
            
            showTab('keys');
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
            } catch (error) {
                console.error("Logout API call failed:", error);
            }

            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            
            authToken = null;
            currentUser = null;
            userRole = null;
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            document.getElementById('loginForm').reset();
            showAlert('loginAlert', 'You have been logged out.', 'success');
        }

        async function loadKeys() {
            try {
                const response = await fetch(`${API_BASE}/keys`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayKeys(data.keys);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load keys');
                }
            } catch (error) {
                showAlert('appAlert', `Failed to load API keys: ${error.message}`, 'error');
                if (error.message.includes('token')) { logout(); }
            }
        }

        function displayKeys(keys) {
            // Updated to ensure it always creates the tbody if missing or empty
            let tbody = keysTableBody;
            if (!tbody) { // Fallback if tbody somehow wasn't found initially
                const table = document.querySelector('.keys-table');
                if (table) {
                    tbody = document.createElement('tbody');
                    tbody.id = 'keysTableBody';
                    table.appendChild(tbody);
                } else {
                    // If no table exists, recreate the whole container including the table
                    document.getElementById('keysContainer').innerHTML = `
                        <table class="keys-table">
                            <thead>
                                <tr>
                                    <th>Date Created</th>
                                    <th>User</th>
                                    <th>Key Name</th>
                                    <th>API Key</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="keysTableBody"></tbody>
                        </table>`;
                    tbody = document.getElementById('keysTableBody'); // Get the newly created tbody
                }
            }

            if (keys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No API keys found. Add your first key to get started.</td></tr>';
                return;
            }
            
            tbody.innerHTML = keys.map(key => {
                const displayApiKey = '***********************************'; // Fully masked for list view
                return `
                    <tr>
                        <td>${new Date(key.created_at).toLocaleDateString()}</td>
                        <td>${key.created_by || 'N/A'}</td>
                        <td>${key.key_name}</td>
                        <td class="api-key-cell">${displayApiKey}</td>
                        <td class="description-cell">${key.description || 'No description'}</td>
                        <td class="action-cell">
                            <button class="btn btn-secondary" data-keyname="${key.key_name}" style="font-size: 10px; padding: 5px 8px;">Edit</button>
                            <button class="btn btn-danger" data-keyname="${key.key_name}" style="font-size: 10px; padding: 5px 8px;">Delete</button>
                            <button class="btn" data-keyname="${key.key_name}" style="font-size: 10px; padding: 5px 8px;">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Rest of the functions (handleKeySubmit, loadLogs, clearLogFilters, displayLogs, loadUsers, displayUsers, showAddUserModal, handleUserSubmit, showTab, closeModal, showAlert, window.onclick)
        // are already correct and remain outside the setupEventListeners for global access.
        // I will not repeat them here for brevity but they are included in the complete code block.
        async function handleKeySubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const keyData = {
                key_name: formData.get('keyName'),
                api_key: formData.get('apiKey'),
                description: formData.get('keyDescription')
            };

            if (editingKey) {
                const currentInputValue = keyData.api_key;
                const maskedDisplay = getMaskedApiKeyDisplay(tempFullApiKey);

                if ((currentInputValue === maskedDisplay && currentInputValue !== tempFullApiKey) ||
                    (currentInputValue === tempFullApiKey && toggleCheckbox.checked)) {
                    delete keyData.api_key;
                } else if (currentInputValue.trim() === '') {
                    delete keyData.api_key;
                }
            }

            keyData.description = keyData.description.trim();
            
            try {
                const url = editingKey ? `${API_BASE}/keys/${editingKey}` : `${API_BASE}/keys`;
                const method = editingKey ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(keyData)
                });
                
                if (response.ok) {
                    showAlert('appAlert', `API key ${editingKey ? 'updated' : 'added'} successfully`, 'success');
                    closeModal('keyModal');
                    loadKeys();
                    loadLogs();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save key');
                }
            } catch (error) {
                showAlert('appAlert', `Operation failed: ${error.message}`, 'error');
                if (error.message.includes('token')) { logout(); }
            }
        }

        async function loadLogs() {
            try {
                const userFilter = document.getElementById('logUserFilter').value.trim();
                const actionFilter = document.getElementById('logActionFilter').value.trim();
                const ipFilter = document.getElementById('logIpFilter').value.trim();

                let queryParams = new URLSearchParams();
                if (userFilter) queryParams.append('user_name', userFilter);
                if (actionFilter) queryParams.append('action', actionFilter);
                if (ipFilter) queryParams.append('ip_address', ipFilter);

                const response = await fetch(`${API_BASE}/logs?${queryParams.toString()}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayLogs(data.logs);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load logs');
                }
            } catch (error) {
                showAlert('appAlert', `Failed to load logs: ${error.message}`, 'error');
                if (error.message.includes('token')) { logout(); }
            }
        }

        function clearLogFilters() {
            document.getElementById('logUserFilter').value = '';
            document.getElementById('logActionFilter').value = '';
            document.getElementById('logIpFilter').value = '';
            loadLogs();
        }

        function displayLogs(logs) {
            const tbody = document.getElementById('logsTableBody');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No logs found</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>${log.user_name || 'Unknown'}</td>
                    <td>${log.key_name || '-'}</td>
                    <td>${log.action}</td>
                    <td>${log.ip_address || '-'}</td>
                    <td>${log.success ? '‚úÖ' : '‚ùå'}</td>
                </tr>
            `).join('');
        }

        async function loadUsers() {
            if (userRole !== 'admin') {
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Admin access required to view users.</td></tr>';
                document.getElementById('usersTabButton').style.display = 'none';
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayUsers(data.users);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load users');
                }
            } catch (error) {
                showAlert('appAlert', `Failed to load users: ${error.message}`, 'error');
                if (error.message.includes('token')) { logout(); }
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No users found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td><span class="user-badge" style="background: ${user.role === 'admin' ? '#f0ad4e' : '#5bc0de'};">${user.role}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                    <td>${user.is_active ? '‚úÖ Yes' : '‚ùå No'}</td>
                    <td>
                        <button class="btn btn-secondary" data-userid="${user.id}" data-username="${user.username}" data-userrole="${user.role}" data-isactive="${user.is_active}" style="font-size: 10px; padding: 5px 8px;">Edit</button>
                        <button class="btn btn-danger" data-userid="${user.id}" data-username="${user.username}" style="font-size: 10px; padding: 5px 8px;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddUserModal() {
            editingUser = null;
            document.getElementById('userForm').reset();
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('newUsername').disabled = false;
            document.getElementById('newPassword').required = true;
            document.getElementById('newUserRole').value = 'user';
            document.getElementById('userIsActiveGroup').classList.add('hidden');
            document.getElementById('userSubmitBtn').textContent = 'Add User';
            document.getElementById('userModal').style.display = 'flex';
        }

        async function editUser(userId, username, role, isActive) {
            editingUser = userId;
            document.getElementById('userForm').reset();
            document.getElementById('userModalTitle').textContent = `Edit User: ${username}`;
            document.getElementById('newUsername').value = username;
            document.getElementById('newUsername').disabled = true;
            document.getElementById('newPassword').required = false;
            document.getElementById('newUserRole').value = role;
            document.getElementById('newUserIsActive').checked = isActive;
            document.getElementById('userIsActiveGroup').classList.remove('hidden');
            document.getElementById('userSubmitBtn').textContent = 'Update User';
            document.getElementById('userModal').style.display = 'flex';
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const userData = {
                username: formData.get('newUsername'),
                role: formData.get('newUserRole')
            };

            if (formData.get('newPassword')) { userData.password = formData.get('newPassword'); }
            if (editingUser) { userData.is_active = document.getElementById('newUserIsActive').checked; }
            
            try {
                let url = editingUser ? `${API_BASE}/users/${editingUser}` : `${API_BASE}/users`;
                let method = editingUser ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    showAlert('appAlert', `User ${editingUser ? 'updated' : 'added'} successfully`, 'success');
                    closeModal('userModal');
                    loadUsers();
                    loadLogs();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Failed to ${editingUser ? 'update' : 'add'} user`);
                }
            } catch (error) {
                showAlert('appAlert', `User operation failed: ${error.message}`, 'error');
                if (error.message.includes('token')) { logout(); }
            }
        }

        function showAddKeyModal() {
            editingKey = null;
            document.getElementById('keyModalTitle').textContent = 'Add API Key';
            document.getElementById('keyName').disabled = false;
            document.getElementById('keySubmitBtn').textContent = 'Save Key';
            document.getElementById('keyForm').reset();
            apiKeyInput.required = true;
            apiKeyInput.type = 'password';
            toggleCheckbox.checked = false;
            apiKeyVisibilityLabel.textContent = 'Show Full Key';
            tempFullApiKey = '';
            document.getElementById('keyModal').style.display = 'flex';
        }

        function showAddUserModal() {
            editingUser = null;
            document.getElementById('userForm').reset();
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('newUsername').disabled = false;
            document.getElementById('newPassword').required = true;
            document.getElementById('newUserRole').value = 'user';
            document.getElementById('userIsActiveGroup').classList.add('hidden');
            document.getElementById('userSubmitBtn').textContent = 'Add User';
            document.getElementById('userModal').style.display = 'flex';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => { tab.classList.remove('active'); });
            document.querySelectorAll('.tabs .tab').forEach(tabButton => { tabButton.classList.remove('active'); });
            document.getElementById(tabName + 'Tab').classList.add('active');
            if (tabName === 'users') {
                document.getElementById('usersTabButton').classList.add('active');
            } else {
                document.querySelector(`.tabs button[onclick="showTab('${tabName}')"]`).classList.add('active');
            }
            if (tabName === 'keys') { loadKeys(); }
            else if (tabName === 'logs') { loadLogs(); }
            else if (tabName === 'users') { loadUsers(); }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
